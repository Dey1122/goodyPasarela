<!DOCTYPE html>
<html>
<head>
  <script>
    function initializeCheckout() {
      console.log('Script de Niubiz cargado correctamente.');

      function setupCheckout() {
        // Leer parámetros de la URL
        const params = new URLSearchParams(window.location.search);
        const checkoutForm = document.getElementById('checkoutForm');

        if (!checkoutForm) {
          console.error('El formulario checkoutForm no se encontró en el DOM');
          return;
        }

        // Establecer los atributos del formulario con los parámetros de la URL
        checkoutForm.setAttribute('data-sessiontoken', params.get('sessiontoken') || '');
        checkoutForm.setAttribute('data-purchasenumber', params.get('purchasenumber') || '');
        checkoutForm.setAttribute('data-amount', params.get('amount') || '');
        checkoutForm.setAttribute('data-channel', 'web'); // Valor fijo o desde URL
        checkoutForm.setAttribute('data-currency', 'PEN'); // Valor fijo o desde URL
        checkoutForm.setAttribute('data-merchantid', params.get('merchantid') || '');
        checkoutForm.setAttribute('action', params.get('action') || checkoutForm.getAttribute('action'));

        // Validar que los parámetros obligatorios estén presentes
        const requiredParams = ['sessiontoken', 'purchasenumber', 'amount', 'action', 'merchantid'];
        for (const param of requiredParams) {
          if (!params.get(param)) {
            console.error(`ERROR: Falta el parámetro ${param}`);
            return;
          }
        }

        console.log(params.get('sessiontoken'));  // Verifica el sessiontoken
        console.log(params.get('purchasenumber'));  // Verifica el purchasenumber
        console.log(params.get('amount'));  // Verifica el amount


        // Intentar abrir el formulario
        if (typeof VisanetCheckout !== 'undefined') {
          console.log('Abriendo VisanetCheckout...');
          VisanetCheckout.open({
          action: checkoutForm.getAttribute('action'),
          merchantid: checkoutForm.getAttribute('data-merchantid'),
          sessiontoken: checkoutForm.getAttribute('data-sessiontoken'),
          amount: checkoutForm.getAttribute('data-amount'),
          purchasenumber: checkoutForm.getAttribute('data-purchasenumber'),
          channel: 'web',
          currency: 'PEN'
        });
          setTimeout(() => checkModalVisibility(), 1000);
        } else {
          console.error('VisanetCheckout no está definido');
        }
      }

      function checkModalVisibility() {
        console.log('Verificando visibilidad del modal...');
        
        const modal = document.querySelector('[id*="checkout"], [class*="checkout"]');
        
        if (modal) {
          console.log('Modal encontrado, forzando visibilidad...');
          modal.style.display = 'block';
          modal.style.visibility = 'visible';
          modal.style.zIndex = '9999'; 
          modal.style.position = 'fixed'; 
          modal.style.top = '50px'; 
          modal.style.left = '50px'; 
        } else {
          console.log('Modal no encontrado');
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupCheckout);
      } else {
        setupCheckout();
      }
    }

    function handleScriptError() {
      console.error('Error al cargar el script de Niubiz.');
    }
  </script>
  
  <script src="https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js" onload="initializeCheckout()" onerror="handleScriptError()"></script>
</head>
<body>
  <h1>Procesando Pago con Niubiz</h1>
  <p>Configurando formulario de pago...</p>
  <div id="loading-spinner" style="text-align: center; margin: 20px;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
    <p>Cargando pasarela de pago...</p>
  </div>

  <form id="checkoutForm"
    action="https://www.tuweb.com/respuesta"
    method="POST"
    data-sessiontoken=""
    data-channel="web"
    data-merchantid="456879852"
    data-purchasenumber=""
    data-amount=""
    data-currency="PEN"
    data-expirationminutes="10"
    data-timeouturl="https://www.tuweb.com/timeout"
    data-merchantlogo="https://www.tuweb.com/logo.png"
    data-merchantname="Tu Comercio"
    data-buttonsize="MEDIUM"
    data-buttoncolor="NAVY"
    data-formbuttoncolor="#FF0000"
    data-showamount="TRUE">
  </form>
  
  <div id="manual-button-container" style="display: none; text-align: center; margin-top: 20px;">
    <button onclick="forceShowModal()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Forzar Modal Visible</button>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>
