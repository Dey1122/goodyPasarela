<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago Niubiz</title>
</head>
<body>
  <h1>Procesando Pago con Niubiz</h1>
  <p>Configurando formulario de pago...</p>
  
  <div id="loading-spinner" style="text-align: center; margin: 20px;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
    <p>Cargando pasarela de pago...</p>
  </div>

  <!-- Formulario con script de Niubiz embebido -->
  <form id="checkoutForm" action="" method="POST">
    <script 
      src="https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js"
      data-sessiontoken=""
      data-channel="web"
      data-merchantid=""
      data-purchasenumber=""
      data-amount=""
      data-currency="PEN"
      data-expirationminutes="10"
      data-timeouturl="https://dey1122.github.io/responseGoody/"
      data-merchantlogo=""
      data-merchantname="Tu Comercio"
      data-buttonsize="MEDIUM"
      data-buttoncolor="NAVY"
      data-formbuttoncolor="#FF0000"
      data-showamount="TRUE">
    </script>
  </form>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Ocultar el spinner cuando el botón esté listo */
    .payment-ready #loading-spinner {
      display: none;
    }
  </style>

  <script>
    function setupNiubizCheckout() {
      // Leer parámetros de la URL
      const params = new URLSearchParams(window.location.search);
      
      // Validar parámetros obligatorios
      const requiredParams = ['sessiontoken', 'purchasenumber', 'amount', 'action', 'merchantid'];
      const missingParams = [];
      
      for (const param of requiredParams) {
        if (!params.get(param)) {
          missingParams.push(param);
        }
      }
      
      if (missingParams.length > 0) {
        console.error('Faltan parámetros obligatorios:', missingParams);
        document.body.innerHTML = `
          <div style="text-align: center; margin: 50px; color: red;">
            <h2>Error en la configuración</h2>
            <p>Faltan los siguientes parámetros: ${missingParams.join(', ')}</p>
          </div>
        `;
        return;
      }

      // Buscar el script de Niubiz
      const niubizScript = document.querySelector('script[src*="checkout.js"]');
      if (!niubizScript) {
        console.error('Script de Niubiz no encontrado');
        return;
      }

      // Configurar el formulario
      const form = document.getElementById('checkoutForm');
      form.setAttribute('action', params.get('action'));

      // Configurar los atributos del script
      niubizScript.setAttribute('data-sessiontoken', params.get('sessiontoken'));
      niubizScript.setAttribute('data-purchasenumber', params.get('purchasenumber'));
      niubizScript.setAttribute('data-amount', params.get('amount'));
      niubizScript.setAttribute('data-merchantid', params.get('merchantid'));
      niubizScript.setAttribute('data-timeouturl', params.get('action')); // Usar la misma URL de acción como timeout

      console.log('Configuración aplicada:');
      console.log('- Session Token:', params.get('sessiontoken'));
      console.log('- Purchase Number:', params.get('purchasenumber'));
      console.log('- Amount:', params.get('amount'));
      console.log('- Merchant ID:', params.get('merchantid'));
      console.log('- Action URL:', params.get('action'));

      // Ocultar el spinner cuando el botón esté listo
      setTimeout(() => {
        const paymentButton = document.querySelector('button[class*="start-js-btn"]');
        if (paymentButton) {
          document.body.classList.add('payment-ready');
        }
      }, 2000);
    }

    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupNiubizCheckout);
    } else {
      setupNiubizCheckout();
    }
  </script>
</body>
</html>
