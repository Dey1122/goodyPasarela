<!DOCTYPE html>
<html>
<head>
  <script>
    function initializeCheckout() {
      console.log('Script de Niubiz cargado correctamente.');

      function setupCheckout() {
        // Leer parámetros de la URL
        const params = new URLSearchParams(window.location.search);
        const checkoutForm = document.getElementById('checkoutForm');

        if (!checkoutForm) {
          console.error('El formulario checkoutForm no se encontró en el DOM');
          return;
        }

        const sessiontoken = params.get('sessiontoken') || '';
        const purchasenumber = params.get('purchasenumber') || '';
        const amount = params.get('amount') || '';

        // Verificar que los parámetros estén presentes
        if (!sessiontoken || !purchasenumber || !amount) {
          console.error('ERROR: Faltan parámetros en la URL');
          return;
        }

        // Establecer los atributos del formulario con los parámetros de la URL
        checkoutForm.setAttribute('data-sessiontoken', sessiontoken);
        checkoutForm.setAttribute('data-purchasenumber', purchasenumber);
        checkoutForm.setAttribute('data-amount', amount);

        const merchantId = checkoutForm.getAttribute('data-merchantid');
        const action = checkoutForm.getAttribute('action');

        if (!action || !merchantId || !sessiontoken || !purchasenumber || !amount) {
          console.error('ERROR: Faltan parámetros importantes');
          return;
        }

        // Intentar abrir el formulario
        if (typeof VisanetCheckout !== 'undefined') {
          console.log('Abriendo VisanetCheckout...');
          VisanetCheckout.open();
          setTimeout(() => checkModalVisibility(), 1000);
        } else {
          console.error('VisanetCheckout no está definido');
        }
      }

      function checkModalVisibility() {
        console.log('Verificando visibilidad del modal...');
        
        const modal = document.querySelector('[id*="checkout"], [class*="checkout"]');
        
        if (modal) {
          console.log('Modal encontrado, forzando visibilidad...');
          modal.style.display = 'block';
          modal.style.visibility = 'visible';
          modal.style.zIndex = '9999'; 
          modal.style.position = 'fixed'; 
          modal.style.top = '50px'; 
          modal.style.left = '50px'; 
        } else {
          console.log('Modal no encontrado');
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupCheckout);
      } else {
        setupCheckout();
      }
    }

    function handleScriptError() {
      console.error('Error al cargar el script de Niubiz.');
    }
  </script>
  
  <script src="https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js" onload="initializeCheckout()" onerror="handleScriptError()"></script>
</head>
<body>
  <h1>Procesando Pago con Niubiz</h1>
  <p>Configurando formulario de pago...</p>
  <div id="loading-spinner" style="text-align: center; margin: 20px;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
    <p>Cargando pasarela de pago...</p>
  </div>

  <form id="checkoutForm"
    action="https://www.tuweb.com/respuesta"
    method="POST"
    data-sessiontoken=""
    data-channel="web"
    data-merchantid="456879852"
    data-purchasenumber=""
    data-amount=""
    data-expirationminutes="10"
    data-timeouturl="https://www.tuweb.com/timeout"
    data-merchantlogo="https://www.tuweb.com/logo.png"
    data-merchantname="Tu Comercio"
    data-buttonsize="MEDIUM"
    data-buttoncolor="NAVY"
    data-formbuttoncolor="#FF0000"
    data-showamount="TRUE">
  </form>
  
  <div id="manual-button-container" style="display: none; text-align: center; margin-top: 20px;">
    <button onclick="forceShowModal()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Forzar Modal Visible</button>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>
