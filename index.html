<!DOCTYPE html>
<html>
<head>
  <script>
    // Función que se ejecuta cuando el script de Niubiz se ha cargado correctamente
    function initializeCheckout() {
      console.log('Script de Niubiz cargado correctamente.');

      // Leer parámetros de la URL
      const params = new URLSearchParams(window.location.search);

      // Establecer los atributos del formulario con los parámetros de la URL
      const checkoutForm = document.getElementById('checkoutForm');
      
      // Asegurarse de que el formulario exista antes de modificarlo
      if (checkoutForm) {
        checkoutForm.setAttribute('data-sessiontoken', params.get('sessionToken') || '');
        checkoutForm.setAttribute('data-purchasenumber', params.get('purchaseNumber') || '');
        checkoutForm.setAttribute('data-amount', params.get('amount') || '');
        
        // Intentar abrir el pago después de algunos intentos
        let retryCount = 0;
        const maxRetries = 50; // Intentamos 10 veces
        const retryInterval = 500; // Intervalo de 500ms

        const checkAndOpenCheckout = function() {
          if (typeof Checkout !== 'undefined') {
            Checkout.open(); // Abre el formulario de pago
            console.log('Formulario de pago abierto correctamente.');
          } else {
            retryCount++;
            if (retryCount < maxRetries) {
              console.log('Esperando a que el objeto Checkout esté disponible...');
              setTimeout(checkAndOpenCheckout, retryInterval);
            } else {
              console.error('El objeto Checkout no está definido después de varios intentos.');
            }
          }
        };

        // Comenzamos a verificar si el objeto Checkout está disponible
        checkAndOpenCheckout();
      } else {
        console.error('El formulario con el ID checkoutForm no se encuentra en el DOM.');
      }
    }

    // Función para manejar errores en el script de Niubiz
    function handleScriptError() {
      console.error('Hubo un error al cargar el script de Niubiz.');
    }

    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function () {
      // Cargar el script de Niubiz después de que el DOM esté listo
      const script = document.createElement('script');
      script.src = "https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js";
      script.onload = initializeCheckout;
      script.onerror = handleScriptError;
      document.head.appendChild(script);
    });
  </script>
</head>
<body>
  <!-- Formulario de pago -->
  <form id="checkoutForm"
    action="https://www.tuweb.com/respuesta"
    method="POST"
    data-sessiontoken=""
    data-channel="web"
    data-merchantid="456879852"
    data-purchasenumber=""
    data-amount=""
    data-expirationminutes="10"
    data-timeouturl="https://www.tuweb.com/timeout"
    data-merchantlogo="https://www.tuweb.com/logo.png"
    data-merchantname="Tu Comercio"
    data-buttonsize="MEDIUM"
    data-buttoncolor="NAVY"
    data-formbuttoncolor="#FF0000"
    data-showamount="TRUE"
  >
  </form>
</body>
</html>
