<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pago Niubiz</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px }
    .wrap { max-width: 480px; margin: 0 auto; text-align: center }
    .spinner { border:4px solid #eee; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:16px auto }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .payment-ready #loading { display:none }
    .start-js-btn { margin: 20px auto; display: block !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Procesando pago</h2>
    <p id="hint">Cargando pasarela de Niubiz…</p>
    <div id="loading"><div class="spinner"></div></div>

    <!-- El SDK buscará este <form> y generará su botón automáticamente -->
    <form id="checkoutForm" action="" method="POST"></form>
  </div>

  <script>
    (function () {
      // URL FIJA de la función Netlify que recibe el POST de Niubiz
      const RETURN_URL = 'https://goodypasarela.netlify.app/.netlify/functions/niubiz-return';

      // 1) Lee parámetros requeridos desde la URL
      const qs = new URLSearchParams(location.search);
      const required = ['sessiontoken','purchasenumber','amount','merchantid'];
      const missing = required.filter(k => !qs.get(k));

      if (missing.length) {
        alert('Faltan parámetros: ' + missing.join(', '));
        throw new Error('Missing params: ' + missing.join(', '));
      }

      const sessiontoken   = qs.get('sessiontoken');
      const purchasenumber = qs.get('purchasenumber');
      const amount         = qs.get('amount');
      const merchantid     = qs.get('merchantid');
      const currency       = (qs.get('currency') || 'PEN').toUpperCase();

      console.log('Niubiz config:', { sessiontoken, purchasenumber, amount, merchantid, currency, RETURN_URL });

      // 2) Define el action y timeout del formulario SIEMPRE hacia la función Netlify
      const form = document.getElementById('checkoutForm');
      form.setAttribute('action', RETURN_URL);

      // 3) Inserta el SDK de checkout con los atributos requeridos
      const s = document.createElement('script');
      s.src = 'https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js'; // prod: https://static-content.vnforapps.com/v2/js/checkout.js

      s.setAttribute('data-sessiontoken',   sessiontoken);
      s.setAttribute('data-merchantid',     merchantid);
      s.setAttribute('data-purchasenumber', purchasenumber);
      s.setAttribute('data-amount',         amount);
      s.setAttribute('data-currency',       currency);
      s.setAttribute('data-channel',        'web');
      s.setAttribute('data-expirationminutes', '10');
      s.setAttribute('data-timeouturl',     RETURN_URL);
      s.setAttribute('data-merchantname',   'Tu Comercio');
      s.setAttribute('data-buttonsize',     'MEDIUM');
      s.setAttribute('data-buttoncolor',    'NAVY');
      s.setAttribute('data-showamount',     'TRUE');

      s.onload = function () {
        console.log('✅ checkout.js cargado');

        // Cuando el SDK insertó su botón, ocultamos el loader
        setTimeout(() => {
          const btn = document.querySelector('button.start-js-btn, .start-js-btn');
          if (btn) {
            document.body.classList.add('payment-ready');
            console.log('✅ Botón de pago visible');
          } else {
            console.warn('⚠ No apareció el botón automático; creando botón manual');
            if (typeof VisanetCheckout !== 'undefined') {
              // configurar programáticamente
              VisanetCheckout.configure({
                action: RETURN_URL,
                merchantid, sessiontoken, purchasenumber, amount, currency,
                channel: 'web',
                expirationminutes: 10,
                timeouturl: RETURN_URL,
                merchantname: 'Tu Comercio',
                buttonsize: 'MEDIUM',
                buttoncolor: 'NAVY',
                showamount: 'TRUE'
              });

              const manual = document.createElement('button');
              manual.className = 'start-js-btn';
              manual.textContent = 'Pagar ahora';
              manual.style.cssText = 'background:#1e3a8a;color:#fff;padding:12px 20px;border:0;border-radius:8px;font-size:16px;cursor:pointer;';
              manual.onclick = (e) => { e.preventDefault(); try { VisanetCheckout.open(); } catch(e) { console.error(e); } };
              form.appendChild(manual);
              document.body.classList.add('payment-ready');
            }
          }
        }, 1200);
      };

      s.onerror = () => {
        alert('No se pudo cargar la pasarela de pago. Intenta nuevamente.');
      };

      document.body.appendChild(s);
    })();
  </script>
</body>
</html>
