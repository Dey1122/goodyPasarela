<script>
  let sent = false;
  let attempts = 0;
  let intervalId = null;
  let observer = null;

  function postToFlutterOnce(payload) {
    if (sent) return;
    sent = true;
    try { window.FlutterNiubiz?.postMessage(JSON.stringify(payload)); } catch(_) {}
    if (intervalId) clearInterval(intervalId);
    if (observer) observer.disconnect();
  }

  function findTransactionData() {
    const p = new URLSearchParams(location.search);
    let token = p.get('transactionToken');
    let email = p.get('customerEmail');
    let channel = p.get('channel') || 'web';
    return { token, email, channel };
  }

  function processData() {
    const { token, email, channel } = findTransactionData();
    if (token && token.trim()) {
      postToFlutterOnce({ type:'success', transactionToken:token, customerEmail:email, channel });
    }
  }

  // 1 disparo inmediato
  processData();

  // Reintentos limitados
  intervalId = setInterval(() => {
    attempts++;
    if (sent || attempts >= 5) { clearInterval(intervalId); return; }
    processData();
  }, 1000);

  // Si el DOM cambia, volvemos a intentar… pero igual sólo enviaremos una vez
  observer = new MutationObserver(processData);
  observer.observe(document.body, { childList:true, subtree:true  });
</script>
