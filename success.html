<!DOCTYPE html>
<html>
<head>
    <title>Pago Procesado</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Pago Procesado</h1>
        <p>Tu pago est√° siendo verificado...</p>
        <div id="info">Buscando datos de transacci√≥n...</div>
        
        <div id="debugInfo" class="debug-info">
            <h3>Debug Info:</h3>
            <div id="debugContent"></div>
        </div>
    </div>
    
    <script>
        console.log('üéØ P√°gina de √©xito cargada');
        console.log('üìç URL completa:', window.location.href);
        console.log('üìã M√©todo HTTP:', window.location.protocol);
        
        let transactionToken = null;
        let customerEmail = null;
        let channel = null;
        
        // Funci√≥n para mostrar debug info
        function updateDebugInfo(source, data) {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML += `
                <p><strong>${source}:</strong></p>
                <pre>${JSON.stringify(data, null, 2)}</pre>
                <hr>
            `;
        }
        
        // M√©todo 1: Capturar par√°metros de URL (GET)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('transactionToken')) {
            transactionToken = urlParams.get('transactionToken');
            customerEmail = urlParams.get('customerEmail');
            channel = urlParams.get('channel');
            console.log('‚úÖ Datos encontrados en URL');
            updateDebugInfo('URL Parameters', {
                transactionToken, customerEmail, channel
            });
        }
        
        // M√©todo 2: Capturar datos de formularios POST
        function checkForPostData() {
            const forms = document.querySelectorAll('form');
            const inputs = document.querySelectorAll('input[type="hidden"]');
            
            console.log('üîç Formularios encontrados:', forms.length);
            console.log('üîç Inputs ocultos encontrados:', inputs.length);
            
            inputs.forEach(input => {
                console.log(`üìù Input: ${input.name} = ${input.value}`);
                if (input.name === 'transactionToken') {
                    transactionToken = input.value;
                }
                if (input.name === 'customerEmail') {
                    customerEmail = input.value;
                }
                if (input.name === 'channel') {
                    channel = input.value;
                }
            });
            
            if (inputs.length > 0) {
                const formData = {};
                inputs.forEach(input => {
                    formData[input.name] = input.value;
                });
                updateDebugInfo('Form Data', formData);
            }
        }
        
        // M√©todo 3: Interceptar cuando se agregan nuevos elementos al DOM
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    console.log('üîÑ DOM cambi√≥, re-buscando datos...');
                    checkForPostData();
                    checkForTokenData();
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // M√©todo 4: Buscar datos en variables globales o elementos espec√≠ficos
        function checkForTokenData() {
            // Buscar en variables globales
            if (typeof window.transactionToken !== 'undefined') {
                transactionToken = window.transactionToken;
                console.log('‚úÖ Token encontrado en variable global');
            }
            
            // Buscar en elementos con IDs espec√≠ficos
            const tokenElement = document.getElementById('transactionToken');
            if (tokenElement) {
                transactionToken = tokenElement.value || tokenElement.textContent;
                console.log('‚úÖ Token encontrado en elemento');
            }
            
            // Buscar en localStorage (por si Niubiz lo guarda all√≠)
            if (localStorage.getItem('transactionToken')) {
                transactionToken = localStorage.getItem('transactionToken');
                console.log('‚úÖ Token encontrado en localStorage');
            }
        }
        
        // Funci√≥n para procesar los datos y enviar a Flutter
        function processTransactionData() {
            const infoDiv = document.getElementById('info');
            
            if (transactionToken && transactionToken.trim() !== '' && transactionToken !== 'null') {
                console.log('üéØ Token v√°lido encontrado:', transactionToken);
                
                infoDiv.innerHTML = `
                    <p><strong>‚úÖ Transacci√≥n Exitosa</strong></p>
                    <p><strong>Token:</strong> ${transactionToken.substring(0, 8)}...</p>
                    <p><strong>Email:</strong> ${customerEmail || 'No especificado'}</p>
                    <p><strong>Canal:</strong> ${channel || 'web'}</p>
                    <p>üîÑ Procesando autorizaci√≥n autom√°ticamente...</p>
                `;
                
                // Enviar a Flutter
                if (window.FlutterNiubiz) {
                    const data = {
                        type: 'success',
                        transactionToken: transactionToken,
                        customerEmail: customerEmail,
                        channel: channel || 'web'
                    };
                    console.log('üì± Enviando datos a Flutter:', data);
                    window.FlutterNiubiz.postMessage(JSON.stringify(data));
                } else {
                    console.log('‚ö†Ô∏è FlutterNiubiz no disponible, agregando al DOM...');
                    
                    // Crear formulario visible para Flutter
                    const form = document.createElement('form');
                    form.style.display = 'none';
                    form.innerHTML = `
                        <input type="hidden" name="transactionToken" value="${transactionToken}">
                        <input type="hidden" name="customerEmail" value="${customerEmail || ''}">
                        <input type="hidden" name="channel" value="${channel || 'web'}">
                    `;
                    document.body.appendChild(form);
                }
            } else {
                console.log('‚ùå No se encontr√≥ token v√°lido');
                infoDiv.innerHTML = '<p>‚è≥ Esperando datos de transacci√≥n...</p>';
            }
        }
        
        // Ejecutar b√∫squedas iniciales
        checkForPostData();
        checkForTokenData();
        processTransactionData();
        
        // Re-verificar cada 2 segundos por 30 segundos
        let checkCount = 0;
        const maxChecks = 15;
        const checkInterval = setInterval(() => {
            checkCount++;
            console.log(`üîÑ Verificaci√≥n #${checkCount}`);
            
            checkForPostData();
            checkForTokenData();
            
            if (transactionToken || checkCount >= maxChecks) {
                clearInterval(checkInterval);
                processTransactionData();
            }
        }, 2000);
        
        // Debug: Listar todos los elementos del DOM
        setTimeout(() => {
            console.log('üìã Elementos en el DOM:');
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.name || el.id || el.value) {
                    console.log(`  ${el.tagName}: name="${el.name}" id="${el.id}" value="${el.value}"`);
                }
            });
        }, 5000);
    </script>
</body>
</html>
