<!DOCTYPE html>
<html>
<head>
    <title>Pago Procesado</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            max-width: 800px;
            margin: 0 auto;
        }
        .debug { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Pago Procesado</h1>
        <div id="info">‚è≥ Buscando datos de transacci√≥n...</div>
        <div id="debug" class="debug"></div>
    </div>

    <!-- Formulario para capturar datos POST de Niubiz -->
    <form id="niubizForm" method="post" style="display: none;">
        <input type="hidden" name="transactionToken" value="">
        <input type="hidden" name="customerEmail" value="">
        <input type="hidden" name="channel" value="">
    </form>

    <script>
        console.log('üéØ P√°gina success.html cargada');
        
        let debugInfo = [];
        const debugDiv = document.getElementById('debug');
        const infoDiv = document.getElementById('info');
        
        function log(message) {
            console.log(message);
            debugInfo.push(`${new Date().toISOString()}: ${message}`);
            debugDiv.innerHTML = debugInfo.join('<br>');
        }
        
        log('Iniciando b√∫squeda de datos...');
        log('URL: ' + window.location.href);
        log('M√©todo HTTP: ' + (window.location.search ? 'GET' : 'POST'));
        
        // Funci√≥n para buscar datos
        function findTransactionData() {
            let token = null;
            let email = null;
            let channel = null;
            
            // M√©todo 1: URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('transactionToken')) {
                token = urlParams.get('transactionToken');
                email = urlParams.get('customerEmail');
                channel = urlParams.get('channel');
                log('‚úÖ Datos encontrados en URL');
            }
            
            // M√©todo 2: Formularios POST (inputs ocultos)
            const inputs = document.querySelectorAll('input[type="hidden"]');
            log(`Inputs ocultos encontrados: ${inputs.length}`);
            
            inputs.forEach(input => {
                if (input.name === 'transactionToken' && input.value) {
                    token = input.value;
                    log(`‚úÖ Token en formulario: ${token}`);
                }
                if (input.name === 'customerEmail' && input.value) {
                    email = input.value;
                }
                if (input.name === 'channel' && input.value) {
                    channel = input.value;
                }
            });
            
            // M√©todo 3: Buscar en el contenido del body
            const bodyText = document.body.innerText;
            const tokenMatch = bodyText.match(/transactionToken[:\s=]+([A-Z0-9]+)/i);
            if (tokenMatch) {
                token = tokenMatch[1];
                log(`‚úÖ Token en body: ${token}`);
            }
            
            return { token, email, channel };
        }
        
        // Procesar datos encontrados
        function processData() {
            const data = findTransactionData();
            
            if (data.token && data.token.trim() !== '') {
                log(`üéØ Token v√°lido encontrado: ${data.token}`);
                
                infoDiv.innerHTML = `
                    <div style="color: green;">
                        <strong>‚úÖ Transacci√≥n Exitosa</strong><br>
                        Token: ${data.token.substring(0, 12)}...<br>
                        Email: ${data.email || 'No especificado'}<br>
                        Canal: ${data.channel || 'web'}
                    </div>
                `;
                
                // Enviar a Flutter
                if (window.FlutterNiubiz) {
                    const message = {
                        type: 'success',
                        transactionToken: data.token,
                        customerEmail: data.email,
                        channel: data.channel || 'web'
                    };
                    log('üì± Enviando a Flutter: ' + JSON.stringify(message));
                    window.FlutterNiubiz.postMessage(JSON.stringify(message));
                } else {
                    log('‚ö†Ô∏è FlutterNiubiz no disponible');
                }
            } else {
                log('‚ùå No se encontr√≥ token v√°lido');
            }
        }
        
        // Ejecutar an√°lisis
        processData();
        
        // Re-intentar cada 2 segundos por 20 segundos
        let attempts = 0;
        const maxAttempts = 10;
        const interval = setInterval(() => {
            attempts++;
            log(`üîÑ Intento ${attempts}/${maxAttempts}`);
            
            const data = findTransactionData();
            if (data.token || attempts >= maxAttempts) {
                clearInterval(interval);
                processData();
            }
        }, 2000);
        
        // Monitor de cambios en DOM
        const observer = new MutationObserver(() => {
            log('üîÑ DOM cambi√≥, re-analizando...');
            processData();
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>
